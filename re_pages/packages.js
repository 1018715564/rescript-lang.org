// Generated by ReScript, PLEASE EDIT WITH CARE

import * as Fs from "fs";
import * as Icon from "../components/Icon.js";
import * as Path from "path";
import * as Curry from "bs-platform/lib/es6/curry.js";
import * as React from "react";
import * as Js_null from "bs-platform/lib/es6/js_null.js";
import FuseJs from "fuse.js";
import * as Process from "process";
import * as Markdown from "../components/Markdown.js";
import * as Belt_Array from "bs-platform/lib/es6/belt_Array.js";
import * as Belt_Option from "bs-platform/lib/es6/belt_Option.js";
import * as Caml_option from "bs-platform/lib/es6/caml_option.js";

function shouldFilter(res) {
  if (res.TAG || !res._0.name.startsWith("@elm-react")) {
    return false;
  } else {
    return true;
  }
}

function isOfficial(res) {
  if (res.TAG) {
    return res._0.official;
  }
  var pkg = res._0;
  if (pkg.name === "bs-platform") {
    return true;
  } else {
    return pkg.name.startsWith("@rescript/");
  }
}

function applyNpmSearch(packages, pattern) {
  var fuseOpts = {
    shouldSort: true,
    includeScore: true,
    threshold: 0.2,
    location: 0,
    distance: 30,
    minMatchCharLength: 1,
    keys: [
      "meta.uid",
      "name",
      "keywords"
    ]
  };
  var fuser = new FuseJs(packages, fuseOpts);
  return fuser.search(pattern);
}

function applyUrlResourceSearch(urls, pattern) {
  var fuseOpts = {
    shouldSort: true,
    includeScore: true,
    threshold: 0.2,
    location: 0,
    distance: 30,
    minMatchCharLength: 1,
    keys: [
      "name",
      "keywords"
    ]
  };
  var fuser = new FuseJs(urls, fuseOpts);
  return fuser.search(pattern);
}

function applySearch(resources, pattern) {
  var match = Belt_Array.reduce(resources, [
        [],
        []
      ], (function (acc, next) {
          var resources = acc[1];
          var npms = acc[0];
          if (next.TAG) {
            resources.push(next._0);
          } else {
            npms.push(next._0);
          }
          return [
                  npms,
                  resources
                ];
        }));
  var filteredNpm = Belt_Array.map(applyNpmSearch(match[0], pattern), (function (m) {
          return {
                  TAG: 0,
                  _0: m.item,
                  [Symbol.for("name")]: "Npm"
                };
        }));
  var filteredUrls = Belt_Array.map(applyUrlResourceSearch(match[1], pattern), (function (m) {
          return {
                  TAG: 1,
                  _0: m.item,
                  [Symbol.for("name")]: "Url"
                };
        }));
  return Belt_Array.concat(filteredNpm, filteredUrls);
}

function Packages$SearchBox(Props) {
  var completionValuesOpt = Props.completionValues;
  var value = Props.value;
  var onClear = Props.onClear;
  var placeholderOpt = Props.placeholder;
  var onValueChange = Props.onValueChange;
  var completionValues = completionValuesOpt !== undefined ? completionValuesOpt : [];
  var placeholder = placeholderOpt !== undefined ? placeholderOpt : "";
  var match = React.useState(function () {
        return /* Inactive */1;
      });
  var setState = match[1];
  var state = match[0];
  var textInput = React.useRef(null);
  var onMouseDownClear = function (evt) {
    evt.preventDefault();
    return Curry._1(onClear, undefined);
  };
  var onAreaFocus = function (evt) {
    var el = evt.target;
    var isDiv = (el.type == null);
    if (isDiv && state === /* Inactive */1) {
      return Belt_Option.forEach(Caml_option.nullable_to_opt(textInput.current), (function (el) {
                    el.focus();
                    
                  }));
    }
    
  };
  var onFocus = function (param) {
    return Curry._1(setState, (function (param) {
                  return /* Active */0;
                }));
  };
  var onBlur = function (param) {
    return Curry._1(setState, (function (param) {
                  return /* Inactive */1;
                }));
  };
  var onKeyDown = function (evt) {
    var key = evt.key;
    var ctrlKey = evt.ctrlKey;
    var full = (
      ctrlKey ? "CTRL+" : ""
    ) + key;
    switch (full) {
      case "Escape" :
          return Curry._1(onClear, undefined);
      case "Tab" :
          if (completionValues.length !== 1) {
            return ;
          }
          var targetValue = Belt_Array.getExn(completionValues, 0);
          if (targetValue !== value) {
            evt.preventDefault();
            return Curry._1(onValueChange, targetValue);
          } else {
            return ;
          }
      default:
        return ;
    }
  };
  var onChange = function (evt) {
    evt.preventDefault();
    return Curry._1(onValueChange, evt.target.value);
  };
  return React.createElement("div", {
              className: (
                state === /* Active */0 ? "border-fire" : "border-fire-40"
              ) + " flex items-center border rounded-lg py-4 px-5",
              tabIndex: -1,
              onFocus: onAreaFocus,
              onBlur: onBlur
            }, React.createElement(Icon.MagnifierGlass.make, {
                  className: (
                    state === /* Active */0 ? "text-fire" : "text-fire-80"
                  ) + " w-4 h-4"
                }), React.createElement("input", {
                  ref: textInput,
                  className: "text-16 outline-none ml-4 w-full",
                  placeholder: placeholder,
                  type: "text",
                  value: value,
                  onKeyDown: onKeyDown,
                  onFocus: onFocus,
                  onChange: onChange
                }), React.createElement("button", {
                  className: value === "" ? "hidden" : "block",
                  onFocus: onFocus,
                  onMouseDown: onMouseDownClear
                }, React.createElement(Icon.Close.make, {
                      className: "w-4 h-4 text-fire"
                    })));
}

function Packages$Card(Props) {
  var value = Props.value;
  var onKeywordSelect = Props.onKeywordSelect;
  var linkBox;
  if (value.TAG) {
    linkBox = null;
  } else {
    var pkg = value._0;
    var repositoryHref = pkg.repositoryHref;
    var repoEl;
    if (repositoryHref !== null) {
      var name = repositoryHref.startsWith("https://github.com") ? "Github" : (
          repositoryHref.startsWith("https://gitlab.com") ? "Gitlab" : "Repository"
        );
      repoEl = React.createElement(React.Fragment, undefined, React.createElement("span", undefined, "|"), React.createElement("a", {
                className: "hover:text-fire",
                href: repositoryHref,
                rel: "noopener noreferrer",
                target: "_blank"
              }, name));
    } else {
      repoEl = null;
    }
    linkBox = React.createElement("div", {
          className: "text-14 space-x-2 mt-1"
        }, React.createElement("a", {
              className: "hover:text-fire",
              href: pkg.npmHref,
              target: "_blank"
            }, "NPM"), repoEl);
  }
  var titleHref;
  if (value.TAG) {
    titleHref = value._0.urlHref;
  } else {
    var pkg$1 = value._0;
    titleHref = Belt_Option.getWithDefault(Caml_option.null_to_opt(pkg$1.repositoryHref), pkg$1.npmHref);
  }
  var match;
  if (value.TAG) {
    var match$1 = value._0;
    match = [
      match$1.name,
      match$1.description,
      match$1.keywords
    ];
  } else {
    var match$2 = value._0;
    match = [
      match$2.name,
      match$2.description,
      match$2.keywords
    ];
  }
  return React.createElement("div", {
              className: "bg-gray-5-tr py-6 rounded-lg p-4"
            }, React.createElement("a", {
                  className: "font-bold hover:text-fire text-18",
                  href: titleHref,
                  target: "_blank"
                }, match[0]), linkBox, React.createElement("div", {
                  className: "mt-4 text-16"
                }, match[1]), React.createElement("div", {
                  className: "space-x-2 mt-4"
                }, Belt_Array.map(match[2], (function (keyword) {
                        var onMouseDown = Belt_Option.map(onKeywordSelect, (function (cb, evt) {
                                evt.preventDefault();
                                return Curry._1(cb, keyword);
                              }));
                        var tmp = {
                          key: keyword,
                          className: "hover:pointer px-2 rounded-lg text-white bg-fire-80 text-14"
                        };
                        if (onMouseDown !== undefined) {
                          tmp.onMouseDown = Caml_option.valFromOption(onMouseDown);
                        }
                        return React.createElement("button", tmp, keyword);
                      }))));
}

function Packages$Category(Props) {
  var title = Props.title;
  var children = Props.children;
  return React.createElement("div", undefined, React.createElement("h3", {
                  className: "font-sans font-medium text-gray-100 tracking-wide text-14 uppercase mb-2"
                }, title), React.createElement("div", undefined, children));
}

function $$default(props) {
  var match = React.useState(function () {
        return /* All */0;
      });
  var setState = match[1];
  var state = match[0];
  var npms = Belt_Array.map(props.packages, (function (pkg) {
          return {
                  TAG: 0,
                  _0: pkg,
                  [Symbol.for("name")]: "Npm"
                };
        }));
  var urls = Belt_Array.map(props.urlResources, (function (res) {
          return {
                  TAG: 1,
                  _0: res,
                  [Symbol.for("name")]: "Url"
                };
        }));
  var allResources = Belt_Array.concat(npms, urls);
  var resources = state ? applySearch(allResources, state._0) : allResources;
  var onValueChange = function (value) {
    Curry._1(setState, (function (param) {
            if (value === "") {
              return /* All */0;
            } else {
              return {
                      _0: value,
                      [Symbol.for("name")]: "Filtered"
                    };
            }
          }));
    
  };
  var searchValue = state ? state._0 : "";
  var onClear = function (param) {
    return Curry._1(setState, (function (param) {
                  return /* All */0;
                }));
  };
  var match$1 = Belt_Array.reduce(resources, [
        [],
        []
      ], (function (acc, next) {
          var community = acc[1];
          var official = acc[0];
          if (isOfficial(next)) {
            official.push(next);
          } else if (!shouldFilter(next)) {
            community.push(next);
          }
          return [
                  official,
                  community
                ];
        }));
  var communityResources = match$1[1];
  var officialResources = match$1[0];
  var onKeywordSelect = function (keyword) {
    return Curry._1(setState, (function (param) {
                  return {
                          _0: keyword,
                          [Symbol.for("name")]: "Filtered"
                        };
                }));
  };
  var officialCategory = officialResources.length !== 0 ? React.createElement(Packages$Category, {
          title: "Official Resources",
          children: React.createElement("div", {
                className: "space-y-4"
              }, Belt_Array.map(officialResources, (function (res) {
                      return React.createElement(Packages$Card, {
                                  value: res,
                                  onKeywordSelect: onKeywordSelect,
                                  key: res._0.name
                                });
                    })))
        }) : null;
  var communityCategory = communityResources.length !== 0 ? React.createElement(Packages$Category, {
          title: "Community Resources",
          children: React.createElement("div", {
                className: "space-y-4"
              }, Belt_Array.map(communityResources, (function (res) {
                      return React.createElement(Packages$Card, {
                                  value: res,
                                  onKeywordSelect: onKeywordSelect,
                                  key: res._0.name
                                });
                    })))
        }) : null;
  return React.createElement("div", undefined, React.createElement(Markdown.H1.make, {
                  children: "Community Packages"
                }), React.createElement(Packages$SearchBox, {
                  value: searchValue,
                  onClear: onClear,
                  placeholder: "Enter a search term, name, keyword, etc",
                  onValueChange: onValueChange
                }), React.createElement("div", {
                  className: "mt-12 space-y-8"
                }, officialCategory, communityCategory));
}

function getStaticProps(_ctx) {
  var __x = fetch("https://registry.npmjs.org/-/v1/search?text=keywords:rescript");
  var __x$1 = __x.then(function (response) {
        return response.json();
      });
  return __x$1.then(function (data) {
              var pkges = Belt_Array.map(data.objects, (function (item) {
                      var pkg = item.package;
                      return {
                              name: pkg.name,
                              version: pkg.version,
                              keywords: pkg.keywords,
                              description: pkg.description,
                              repositoryHref: Js_null.fromOption(pkg.links.repository),
                              npmHref: pkg.links.npm
                            };
                    }));
              var index_data_dir = Path.join(Process.cwd(), "./data");
              var urlResources = JSON.parse(Fs.readFileSync(Path.join(index_data_dir, "packages_url_resources.json"), "utf8"));
              console.log(urlResources);
              var props = {
                packages: pkges,
                urlResources: urlResources
              };
              return Promise.resolve({
                          props: props,
                          revalidate: 43200
                        });
            });
}

export {
  $$default ,
  $$default as default,
  getStaticProps ,
  
}
/* fs Not a pure module */
